var __defProp=Object.defineProperty;var __defNormalProp=(obj,key,value)=>key in obj?__defProp(obj,key,{enumerable:!0,configurable:!0,writable:!0,value}):obj[key]=value;var __name=(target,value)=>__defProp(target,"name",{value,configurable:!0});var __publicField=(obj,key,value)=>(__defNormalProp(obj,typeof key!="symbol"?key+"":key,value),value),__accessCheck=(obj,member,msg)=>{if(!member.has(obj))throw TypeError("Cannot "+msg)};var __privateGet=(obj,member,getter)=>(__accessCheck(obj,member,"read from private field"),getter?getter.call(obj):member.get(obj)),__privateAdd=(obj,member,value)=>{if(member.has(obj))throw TypeError("Cannot add the same private member more than once");member instanceof WeakSet?member.add(obj):member.set(obj,value)},__privateSet=(obj,member,value,setter)=>(__accessCheck(obj,member,"write to private field"),setter?setter.call(obj,value):member.set(obj,value),value);var CFG={id:"data-inspector",SETTINGS:{allowEditing:"allowEditing",allowEditingUnsupported:"allowEditingUnsupported",allowUsers:"allowUsers",functions:"functions",results:"results",mode:"mode",tooltip:"tooltip"},COLORS:{main:"color:deepskyblue",number:"color:mediumpurple",label:"color:mediumseagreen",id:"color:darkseagreen",unset:"color:unset"}};var copyToClipboard=__name(async text=>{if(window.isSecureContext)return navigator.clipboard.writeText(text);ui.notification.warn("Copying to clipboard requires secure contet (HTTPS) in modern browsers.")},"copyToClipboard");var DATA_TYPES={undefined:-1,null:0,object:110,number:410,boolean:420,string:430,array:120,map:510,collection:520,function:910,getter:980,model:1010,data:2010,document:2020,custom:1e4},DATA_TYPE_INVERTED=invertObject(DATA_TYPES),getTypeName=__name(value=>{if(value===void 0)return"undefined";if(value===null)return"null";let type=typeof value;if(["string","number","function","boolean"].includes(type))return type;if(Array.isArray(value))return"array";let n=value.__proto__.constructor.name;return n==="Object"?"object":n==="Map"?"map":"_"+n},"getTypeName");var getTypeId=__name(value=>{if(value===void 0)return DATA_TYPES.undefined;if(value===null)return DATA_TYPES.null;switch(typeof value){case"string":return DATA_TYPES.string;case"number":return DATA_TYPES.number;case"function":return DATA_TYPES.function;case"boolean":return DATA_TYPES.boolean}if(Array.isArray(value))return DATA_TYPES.array;if(value instanceof foundry.abstract.Document)return DATA_TYPES.document;if(value instanceof foundry.abstract.DocumentData)return DATA_TYPES.data;if(value instanceof foundry.abstract.DataModel)return DATA_TYPES.model;let n=value.__proto__.constructor.name;return n==="Object"?DATA_TYPES.object:n==="Map"?DATA_TYPES.map:n==="Collection"?DATA_TYPES.collection:DATA_TYPES.custom},"getTypeId");var ValueEditor=class extends FormApplication{_path;_type;document;parentApp;static get supportedTypes(){return[DATA_TYPES.number,DATA_TYPES.string,DATA_TYPES.boolean,DATA_TYPES.null,DATA_TYPES.undefined]}constructor(document,path,type,{isToken=!1,app,resolve}={}){let title=["Data Inspector"];title.push(document.name),title.push(path);let options={};options.title=title.join(": "),options.id="lil-data-inspector-"+document.uuid+"-"+path,super(void 0,options),this.resolve=resolve,this.parentApp=app,this.isToken=isToken,this._path=path,this.document=document;let value=getProperty(document.toObject(),path);this.originalTypeId=type??getTypeId(value),this.originalTypeName=DATA_TYPE_INVERTED[this.originalTypeId],this._type=this.originalTypeName}get template(){return`modules/${CFG.id}/template/editor.hbs`}static get defaultOptions(){let _default=super.defaultOptions;return mergeObject(_default,{..._default,title:"Data Inspector \u2013 Editor",classes:[..._default.classes,"koboldworks","data-inspector-editor"],submitOnChange:!1,submitOnClose:!1,closeOnSubmit:!1,resizable:!0,width:520,height:360})}async getData(){let data=super.getData(),doc=this.document,value=getProperty(doc.toObject(),this._path),typeId=this._typeId=getTypeId(value),typeName=this._type??getTypeName(value),originalTypeName=this.originalTypeName;return this.object={value},data.document=doc,data.path=this._path,data.value=value,data.type=typeName,data.typeName=typeName,data.originalType=originalTypeName,data.similarType=originalTypeName==="string"&&["text","html"].includes(typeName),data.isHTML=typeName==="html",data.isString=["html","text","string"].includes(typeName),data.isLongString=typeName==="html"||typeName==="text"||originalTypeName==="string"&&(data.value.length>16||data.value.indexOf(`
`)>=0),data.isUnsupported=!ValueEditor.supportedTypes.includes(typeId),data.isActor=doc instanceof Actor,data.isItem=doc instanceof Item,data.simpleType=["number","string","boolean"].includes(typeName),data.deadType=["null","undefined"].includes(typeName),data.selectedType=this._type,data.types={number:"Number",boolean:"Boolean",string:"String",null:"Null",undefined:"Undefined",text:"Text Block",html:"HTML"},data.enriched=data.isHTML?await TextEditor.enrichHTML(this.object.value,{async:!0}):null,data.isToken=this.isToken,data.TYPES=DATA_TYPES,data}activateListeners(jq){super.activateListeners(jq);let html=jq[0],app=this,parentApp=this.parentApp,isToken=this.isToken;html.querySelector('select[name="type"]')?.addEventListener("change",ev=>{ev.preventDefault(),ev.stopPropagation();let oldType=this._type,newType=ev.target.value;this._type=newType,this.render()}),html.querySelector('select[name="type"]')?.addEventListener("change",function(ev){ev.preventDefault(),ev.stopPropagation(),app._type=this.value,app.editors={},app.render(!0)});let doc=this.document,path=this._path;html.querySelector("button.delete")?.addEventListener("click",ev=>{ev.preventDefault(),ev.stopPropagation();let updateData={[path.replace(/([^.]+)$/,m=>`-=${m}`)]:null};console.log("Delete:",updateData),Dialog.confirm({title:"Delete data?",content:`<p>Delete: <code>${path}</code></p>`,yes:()=>doc.update(updateData).finally(_=>app.close()),defaultYes:!1})})}_updateObject(event,formData){let type=this._type,path=this._path,doc=this.document;console.log(formData);let value=formData.value;type==="undefined"?value=void 0:type==="null"&&(value=null),console.log("Setting data:",type,path,value);let updateData={[path]:value};doc.update(updateData).then(_=>this.close())}async close(opts){return this.resolve(),super.close(opts)}};__name(ValueEditor,"ValueEditor");var dataKeySorter=__name((a,b)=>a.key.localeCompare(b.key),"dataKeySorter"),ChildKeyData=class{key;type;constructor(key,type){this.key=key,this.type=type}};__name(ChildKeyData,"ChildKeyData");var _inRoll,_inSource,_inDerived,_inTemporary,_childKeys,_DataStructure=class{constructor({key,path,value,parent,type,treeType,depth}){__publicField(this,"key");__publicField(this,"path");__publicField(this,"type");__publicField(this,"typeId");__publicField(this,"root");__publicField(this,"value");__publicField(this,"parent");__publicField(this,"children",[]);__publicField(this,"depth",0);__publicField(this,"treetype");__publicField(this,"_sourceData");__publicField(this,"_derivedData");__publicField(this,"_rollData");__publicField(this,"_overides");__privateAdd(this,_inRoll,void 0);__privateAdd(this,_inSource,void 0);__privateAdd(this,_inDerived,void 0);__privateAdd(this,_inTemporary,void 0);__privateAdd(this,_childKeys,void 0);this.key=key,this.path=path,this.typeId=type??getTypeId(value),this.type=DATA_TYPE_INVERTED[this.typeId],this.value=value,this.parent=parent,this.root=parent?.root??parent,this.depth=depth,this.treetype=treeType}get basePath(){return this.path.replace(/^system\./,"")}get isRollData(){return this.root.treetype==="rolldata"}get isBigString(){return this.typeId===DATA_TYPES.string&&this.value?.length>24}get isNull(){return this.typeId===DATA_TYPES.null}get isFunction(){return this.typeId===DATA_TYPES.function}get isGetter(){return this.typeId===DATA_TYPES.getter}get isUndefined(){return this.typeId===DATA_TYPES.undefined}get isNullish(){return!!([DATA_TYPES.null,DATA_TYPES.undefined].includes(this.typeId)||this.isArray&&this.value.length===0||(this.isMap||this.isCollection)&&this.value.size==0)}get identifier(){switch(this.typeId){case DATA_TYPES.custom:case DATA_TYPES.model:return this.value.constructor.name;default:return null}}get isModel(){return this.typeId===DATA_TYPES.model}get isArray(){return this.typeId===DATA_TYPES.array}get isMap(){return this.typeId===DATA_TYPES.map}get isCollection(){return this.typeId===DATA_TYPES.collection}get isObject(){return this.typeId===DATA_TYPES.object}get isDocument(){return[DATA_TYPES.document,DATA_TYPES.data].includes(this.typeId)}get documentId(){if(this.typeId===DATA_TYPES.data)return this.value._id;if(this.typeId===DATA_TYPES.document)return this.value.id}get hasValues(){return this.isContainer&&!this.isArray?"total"in this.value||"value"in this.value||"max"in this.value:!1}get values(){let data={value:this.value.value,haveValue:!1,max:this.value.max,haveMax:!1,isValue:!1,total:this.value.total,haveTotal:!1,noValues:!1};return(data.value===null||typeof data.value=="number")&&(data.value=`${data.value}`,data.haveValue=!0),(data.max===null||typeof data.max=="number")&&(data.max=`${data.max}`,data.haveMax=!0),(data.total===null||typeof data.total=="number")&&(data.total=`${data.total}`,data.haveTotal=!0),(data.haveValue||data.haveMax)&&(data.isValue=!0,data.isValueOf=data.haveValue&&data.haveMax),!data.isValue&&!data.haveTotal&&(data.noValues=!0),data}get className(){return this.value.__proto__.constructor.name}get isEmpty(){if(this.isNullish)return!0;switch(this.typeId){case DATA_TYPES.array:return this.value.length==0;case DATA_TYPES.object:return foundry.utils.isEmpty(this.value);case DATA_TYPES.map:case DATA_TYPES.collection:return this.value.size===0;case DATA_TYPES.custom:return this.children.length==0}return!1}get isString(){return this.typeId===DATA_TYPES.string}get isNumber(){return this.typeId===DATA_TYPES.number}get inArray(){return this.parent?.isArray??!1}get isContainer(){return[DATA_TYPES.array,DATA_TYPES.object,DATA_TYPES.model,DATA_TYPES.map,DATA_TYPES.collection,DATA_TYPES.custom].includes(this.typeId)}get isChildless(){return[DATA_TYPES.boolean,DATA_TYPES.string,DATA_TYPES.null,DATA_TYPES.undefined,DATA_TYPES.number].includes(this.typeId)}get isCustom(){return this.typeId===DATA_TYPES.custom}get formattedValue(){return this.typeId===DATA_TYPES.undefined?"undefined":this.typeId===DATA_TYPES.null?"null":this.typeId===DATA_TYPES.function?"function":this.value}get inRollData(){if(__privateGet(this,_inRoll)===void 0){if(this.root.treetype==="rolldata")return __privateSet(this,_inRoll,!0);if(!this.root._rollData)return!1;let path=this.basePath;try{return __privateSet(this,_inRoll,hasProperty(this.root._rollData,path))}catch{}return __privateSet(this,_inRoll,3)}return __privateGet(this,_inRoll)}get inSourceData(){if(__privateGet(this,_inSource)===void 0){if(this.root.treetype==="source")return __privateSet(this,_inSource,!0);if(!this.root._sourceData)return!1;let path=this.basePath;try{let data=this.root._sourceData;return __privateSet(this,_inSource,hasProperty(data,path))}catch{}return __privateSet(this,_inSource,3)}return __privateGet(this,_inSource)}get inDerivedData(){if(__privateGet(this,_inDerived)===void 0){if(this.root.treetype==="derived")return __privateSet(this,_inDerived,!0);if(!this.root._derivedData)return!1;let path=this.basePath;try{let data=this.root._derivedData;return __privateSet(this,_inDerived,hasProperty(data,path))}catch{}return __privateSet(this,_inDerived,3)}return __privateGet(this,_inDerived)}get inTemporaryData(){if(__privateGet(this,_inTemporary)===void 0){if(!this.root._temporaryData)return!1;let path=this.basePath;try{let data=this.root._temporaryData;return __privateSet(this,_inTemporary,hasProperty(data,path))}catch{}return __privateSet(this,_inTemporary,3)}return __privateGet(this,_inTemporary)}get hasOverrides(){return!!this._overrides}get css(){return this.typeId===DATA_TYPES.boolean?this.value?"true":"false":this.typeId===DATA_TYPES.number?this.value===0?"zero":this.value<0?"negative":"positive":""}childKeys(){if(__privateGet(this,_childKeys))return __privateGet(this,_childKeys);if(this.isDocument)return[];switch(this.typeId){case DATA_TYPES.array:return __privateSet(this,_childKeys,[this.value.map(k=>new ChildKeyData(k))]);case DATA_TYPES.collection:case DATA_TYPES.map:return __privateSet(this,_childKeys,[Array.from(this.value.keys()).map(k=>new ChildKeyData(k))]);case DATA_TYPES.model:case DATA_TYPES.object:case DATA_TYPES.custom:{let allKeys=[],rvg=[],rvf=[];if(allKeys.push(...Object.getOwnPropertyNames(this.value).map(k=>new ChildKeyData(k))),this.isModel){let i=allKeys.length;for(;i--;)["parent","_source"].includes(allKeys[i].key)&&allKeys.splice(i,1)}if(_DataStructure.includeFunctions){let proto=this.value,ignored=["constructor","toString","almostEqual","__proto__","prototype","between"];do{if(proto.constructor.name==="Object")break;let keys=Object.getOwnPropertyNames(proto);for(let key of keys){if(ignored.includes(key))continue;let desc=Object.getOwnPropertyDescriptor(proto,key);desc&&(desc.get!==void 0?rvg.push(new ChildKeyData(key,DATA_TYPES.getter)):typeof desc.value=="function"&&rvf.push(new ChildKeyData(key,DATA_TYPES.function)))}proto=Object.getPrototypeOf(proto)}while(proto)}return __privateSet(this,_childKeys,[allKeys.sort(dataKeySorter),rvg.sort(dataKeySorter),rvf.sort(dataKeySorter)])}default:return __privateSet(this,_childKeys,[])}}fillChildren(){let curpath=this.path,basePath=curpath?.length?curpath:this.key,isArray=this.isArray,isMap=this.isMap||this.isCollection,parseChildren=__name(list=>{list?.forEach((ckData,i)=>{let{key,type}=ckData,trueKey=isArray?i:key,value=isMap?this.value.get(trueKey):this.value[trueKey],path=basePath?`${basePath}.${trueKey}`:trueKey;if(Hooks.call("data-inspector.filterData",this.root.document,path,this.treetype)===!1||getTypeId(value)===DATA_TYPES.function&&!_DataStructure.includeFunctions)return;let c=new _DataStructure({key:trueKey,path,value,parent:this,type,depth:this.depth+1});this.children.push(c)})},"parseChildren"),[all,functions,getters]=this.childKeys();return parseChildren(all),parseChildren(functions),parseChildren(getters),this.children}static recurse(sourceData,key,path,type,{includeFunctions=!1,document}={}){_DataStructure.includeFunctions=includeFunctions??!1;let dt=new _DataStructure({key,path,value:sourceData,parent:null,treeType:type,depth:0});dt.document=document,dt.root=dt;let all={};dt.path&&(all[dt.path]=dt);let itemCount=0,error=!1,recurseChildren=__name(cdt=>{let handleChild=__name(oo=>{if(all[oo.path]=oo,itemCount++,itemCount>25e3){error||(ui.notifications.error("DATA INSPECTOR | Possible cyclic reference encountered; ending inspection early"),console.error(oo.path,`
DATA INSPECTOR | Possible cyclic reference encountered; ending inspection early
`,oo),error=!0);return}try{recurseChildren(oo)}catch(err){throw console.error(err,this),err}},"handleChild");cdt.isChildless||cdt.fillChildren().forEach(handleChild)},"recurseChildren");return recurseChildren(dt),{root:dt,all}}getAtPath(path){let parts=path.split("."),key=parts.shift(),c=__name(()=>{switch(this.typeId){case DATA_TYPES.array:return this.children[parseInt(key)];default:return this.children.find(cd=>cd.key===key)}},"getPart")();return parts.length===0?c:c?.getAtPath(parts.join("."))}},DataStructure=_DataStructure;__name(DataStructure,"DataStructure"),_inRoll=new WeakMap,_inSource=new WeakMap,_inDerived=new WeakMap,_inTemporary=new WeakMap,_childKeys=new WeakMap,__publicField(DataStructure,"includeFunctions",!1);function createTemporaryDocument(doc){let data={name:doc.name+" [Temporary]",type:doc.type,system:{}};return Hooks.call("data-inspector.temporaryData",doc,data),doc instanceof Actor?new Actor(data):new Item(data)}__name(createTemporaryDocument,"createTemporaryDocument");var SearchResult=class{path;keyFocus=!0;match;get mismatch(){return this.indexes.path.length===0}target;score;keyFullMatch;pathFullMatch;indexes={path:[],key:[]};ratio;get good(){return this.ratio>.8}get bad(){return this.ratio<.3}scoring={full:void 0,key:void 0};constructor({path,match,target,score,keyFocus,keyFullMatch,pathFullMatch,pathIndexes,keyIndexes,ratio,scoring}={}){this.path=path,this.match=match,this.target=target,this.keyFocus=keyFocus,this.score=score,this.keyFullMatch=keyFullMatch,this.pathFullMatch=pathFullMatch,this.indexes.path=pathIndexes,this.indexes.key=keyIndexes,this.ratio=ratio,this.scoring=scoring}};__name(SearchResult,"SearchResult");var TermMatch=class{score;indexes;full;half;ratio;consecutives;longestChain;scoring;constructor({indexes,full,half,ratio,consecutives,longestChain,scoring}={}){this.indexes=indexes,this.full=full,this.half=half,this.ratio=ratio,this.consecutives=consecutives,this.longestChain=longestChain,this.scoring=scoring,this.score=scoring.reduce((old,scr)=>old+scr.value)}};__name(TermMatch,"TermMatch");var Score=class{value;description;constructor(value,description){this.value=value,this.description=description}};__name(Score,"Score");var _DataInspectorDialog=class extends FormApplication{_path="";_pathEl;_search="";_searchEnd=!0;_functions=!1;_document=!1;_mode="rolldata";_expandedItems=new Set;_derivedData;_sourceData;_temporaryData;_rollData;_flagData;_overrides;_resultQuality=.7;root;parentActor;paths;constructor(document,options={}){let title=["Data Inspector"],parent=null;document.actor&&(parent=document.actor),parent&&title.push(parent.name),title.push(document.name),options.title=title.join(": "),options.id="lil-data-inspector-"+document.uuid,super(document,options),this._functions=game.settings.get(CFG.id,CFG.SETTINGS.functions),this._resultQuality=game.settings.get(CFG.id,CFG.SETTINGS.results),this._mode=game.settings.get(CFG.id,CFG.SETTINGS.mode),this.document=document,this.parentActor=parent,document.apps[this.appId]=this}get template(){return`modules/${CFG.id}/template/inspector.hbs`}static get defaultOptions(){let _default=super.defaultOptions;return mergeObject(_default,{title:"Data Inspector",classes:[..._default.classes,"koboldworks","data-inspector"],resizable:!0,width:520,height:620,scrollY:["div.data"]})}getDataVariant(doc,mode){switch(mode??this._mode){case"flags":return this._flagData==null&&(this._flagData=doc.flags??{}),{data:this._flagData,path:"flags"};case"override":return this._overrides==null&&(this._overrides=doc.token?.actorData?.system??{}),{data:this._overrides,path:"system"};case"rolldata":return this._rollData==null&&(this._rollData=doc.getRollData()),{data:this._rollData,path:""};case"source":return this._sourceData==null&&(this._sourceData=doc.toObject().system),{data:this._sourceData,path:"system"};default:case"derived":return this._derivedData==null&&(this._derivedData=doc.system),{data:this._derivedData,path:"system"}}}getData(){let data=super.getData(),doc=this.document,isActor=doc instanceof Actor,type=doc.type,typeLabelKey=`${isActor?"ACTOR":"ITEM"}.Type${type.capitalize()}`,typeLabel=game.i18n.localize(typeLabelKey);this._mode==="source"&&(this._temporaryData??=createTemporaryDocument(this.document).toObject()),data.rolldata=this.getDataVariant(doc,"rolldata").data,data.sourcedata=this.getDataVariant(doc,"source").data,data.derived=this.getDataVariant(doc,"derived").data,data.overrides=this.getDataVariant(doc,"override").data,data.flags=this.getDataVariant(doc,"flags").data;let{data:docData,path:basepath}=this.getDataVariant(doc);data.document=doc,data.type=type,data.typeLabel=typeLabel,data.docType=doc.constructor.name,data.dataType=this._mode,data.isRollData=this._mode==="rolldata",data.isSourceData=this._mode==="source",data.isDerivedData=this._mode==="derived",data.isOverrideData=this._mode==="override",data.resultQuality=this._resultQuality;let isRollData=this._mode==="rolldata",isFlags=this._mode==="flags",basePath=isRollData?null:"system",{root,all}=DataStructure.recurse(docData,basepath,basepath,this._mode,{includeFunctions:this._functions,document:doc});return data.data=root,this.root=root,data.model=root.isModel?root.className:null,root.treetype==="source"&&(data.model=doc.system instanceof foundry.abstract.DataModel?doc.system.constructor.name:null),root._sourceData=data.sourcedata,root._derivedData=data.derived,root._rollData=data.rolldata,root._overrides=data.overrides,root._temporaryData=this._temporaryData?.system,data.uuid=doc.uuid,data.search=this._search,data.searchEnd=this._searchEnd,data.includeFunctions=this._functions,data.includeDocument=this._document,data.path=this._path,data.TYPES=DATA_TYPES,data}treeWalker(el,callback,...args){callback(el,...args);let parent=el.parentElement;parent&&["LI","UL"].includes(parent.tagName)&&this.treeWalker(parent,callback,...args)}highlightEl(el,enabled=!0){this._pathEl&&this._pathEl.classList.toggle("selected",!1),el.classList.toggle("selected",enabled),this._pathEl=el}expandDataElTree(el){this.treeWalker(el,this.expandDataEl,!1,!0)}expandDataEl(el,record=!0,expand=void 0){if(el.classList.toggle("hide",!1),!(el.classList.contains("value")||el.classList.contains("empty"))){if(record){let path=el.dataset.path,items=this._expandedItems;el.classList.contains("collapsed")?items.add(path):items.delete(path)}el.classList.toggle("collapsed",expand!==void 0?!expand:void 0),el.classList.toggle("expanded",expand)}}collapseAndClearEl(el,hide=!1,includeValues=!1){el.classList.toggle("hide",hide),el.dataset.matchQuality=null,el.classList.toggle("selected",!1),!(el.classList.contains("value")||el.classList.contains("empty"))&&(el.classList.toggle("collapsed",!0),el.classList.toggle("expanded",!1))}expandData(ev,el){ev.preventDefault(),ev.stopPropagation(),this.expandDataEl(el)}activateListeners(jq){super.activateListeners(jq);let html=jq[0],header=html.querySelector(".header"),appEl=html.closest("[data-appid]");if(appEl){let doc=this.document,item=doc instanceof Item?doc:null;item&&(appEl.dataset.itemId=item.id,appEl.dataset.itemUuid=item.uuid);let actor=doc instanceof Actor?doc:this.parentActor;actor&&(appEl.dataset.actorId=actor.id,appEl.dataset.actorUuid=actor.uuid)}let pathInput=header.querySelector("input.path"),app=this,rolldata=this._mode==="rolldata",rawdata=this._mode==="source";function changeDataSource(ev){let value=ev.target.value;if(app._mode!==value){ev.preventDefault(),ev.stopPropagation(),ev.target.disabled=!0;let path=app._path;if(path.length>0){let pathp=path.split(""),prefix="system.";path[0]==="@"&&app._mode==="rolldata"?pathp.splice(0,1,prefix):path.length>5&&path.startsWith(prefix)&&value==="rolldata"&&pathp.splice(0,prefix.length,"@"),app._path=pathp.join("")}app._path=app.getBasePath(app._path,app._mode),app._mode=value,app._lastSearch=void 0,app.render(!1,{keepCache:!0})}}__name(changeDataSource,"changeDataSource"),header.querySelector("select.type").addEventListener("change",changeDataSource);function changeSearchQuality(ev){app._resultQuality=Number(this.value),app._search.length>0&&app.doSearch(app._search,{forceRefresh:!0})}__name(changeSearchQuality,"changeSearchQuality"),header.querySelector("input.search-quality").addEventListener("change",changeSearchQuality);function copyPath(ev){ev.preventDefault(),ev.stopPropagation();let el=this,path=el.dataset.path,properPath=rolldata?`@${path}`:path;if(pathInput.value=properPath,app._path=properPath,app.highlightEl(el,!0),window.isSecureContext)return copyToClipboard(properPath)}__name(copyPath,"copyPath"),jq.on("click","[data-path]",function(ev){app.expandData(ev,this)}),jq.on("contextmenu","[data-path]",copyPath),pathInput.addEventListener("input",ev=>this.debounceCustomPath(ev.target.value,ev,!0)),pathInput.addEventListener("change",ev=>this.debounceCustomPath(ev.target.value,ev,!1)),html.querySelectorAll("[data-path]").forEach(el=>{let path=el.dataset.path;this._expandedItems.has(path)&&this.expandDataEl(el)});let dataSection=html.querySelector("form > .data");dataSection.addEventListener("dblclick",__name(function(ev){if(ev.preventDefault(),ev.stopPropagation(),_DataInspectorDialog.EDITABLE_MODES.includes(app._mode)){let el=ev.target,ael=el.dataset.path?el:el.closest("[data-path]");ael&&app._openValueEditor(ev,ael.dataset.path)}else ui.notifications.warn(`Editing not supported in "${app._mode}" mode!`)},"openEditor"));let buildSearchCache=__name(el=>{let path=el.dataset.path,key=el.dataset.key,label=el.querySelector("h4");this.paths.set(path,{path,key,element:el,label:label.textContent})},"buildSearchCache"),useTooltips=game.settings.get(CFG.id,CFG.SETTINGS.tooltip),paths=dataSection.querySelectorAll("li[data-path]"),pathPrefix=this._mode==="rolldata"?"@":"";paths.forEach(el=>{if(!useTooltips)return;let dEl=el.querySelector(".details");dEl?.addEventListener("mouseenter",async ev=>{let path=el.dataset.path,dpath=path;if(app._mode!=="rolldata"){let parts=path.split(".");parts.shift(),dpath=parts.join(".")}let dd=this.root?.getAtPath(dpath),typeId=dd.typeId,typeName=typeId!==DATA_TYPES.custom?DATA_TYPE_INVERTED[typeId]:dd.className,isFlags=dd.treetype==="flags",templateData={dd,path:pathPrefix+path,type:typeName,documentId:dd.documentId,isContainer:dd.isContainer||dd.isDocument,children:dd.isContainer||dd.isDocument?dd.children.length:null,isString:dd.isString,length:dd.isString?dd.value.length:null,treetype:dd.treetype,notFlags:!isFlags,inData:{rolldata:{show:!isFlags&&dd.treetype!=="rolldata",label:"DataInspector.Data.Roll",present:isFlags?!1:dd.inRollData},derived:{show:!isFlags&&dd.treetype!=="derived",label:"DataInspector.Data.Derived",present:isFlags?!1:dd.inDerivedData},source:{show:!isFlags&&dd.treetype!=="source",label:"DataInspector.Data.Source",present:isFlags?!1:dd.inSourceData},temporary:{show:dd.treetype==="source",label:"DataInspector.Data.Temporary",present:isFlags?!1:dd.inTemporaryData}}},text=await renderTemplate(`modules/${CFG.id}/template/tooltip.hbs`,templateData);game.tooltip.activate(dEl,{text,direction:"UP",cssClass:"data-inspector-tooltip"})},{passive:!0}),dEl?.addEventListener("mouseleave",()=>game.tooltip.deactivate(),{passive:!0})});let search=header.querySelector("input.search");search.addEventListener("change",ev=>this.debounceSearch(ev.target.value,ev,!1),{passive:!0}),search.addEventListener("input",ev=>this.debounceSearch(ev.target.value,ev,!0),{passive:!0}),this.paths=new Collection,paths.forEach(el=>buildSearchCache(el)),header.querySelector("input.functions").addEventListener("change",ev=>{ev.preventDefault(),ev.stopPropagation(),this._functions=ev.target.checked,this.render()}),this._search.length&&this.debounceSearch(this._search),this._functions&&(this._getGetterValueBound||(this._getGetterValueBound=this._getGetterValue.bind(this)),dataSection.addEventListener("click",function(ev){ev.target.matches(".getter.value")&&(ev.preventDefault(),ev.stopPropagation(),app._getGetterValueBound(ev))})),this.expandSelectedPath()}_openValueEditor(event,path){if(!game.settings.get(CFG.id,CFG.SETTINGS.allowEditing))return ui.notifications.warn("Editing has been disabled.");let pp=path.split("."),currentData=this.document;for(;pp.length>0;){let part=pp.shift();if(currentData=currentData[part],currentData==null&&pp.length>0)return ui.notifications.warn(`Failed to navigate to the target datapath: ${path}`);if(Array.isArray(currentData)&&pp.length>0)return ui.notifications.warn(`Editing arrays or values inside of arrays not supported: ${path}`)}let type=getTypeId(currentData),isSupported=ValueEditor.supportedTypes.includes(type);if(!ValueEditor.supportedTypes.includes(type)&&!game.settings.get(CFG.id,CFG.SETTINGS.allowEditingUnsupported))return ui.notifications.warn(`Unsupported type for editing: ${DATA_TYPE_INVERTED[type]}`);let p=new Promise(resolve=>{new ValueEditor(this.document,path,type,{isToken:this._mode==="override",app:this,resolve}).render(!0,{focus:!0})});this._mode==="flags"&&p.then(_=>{this._flagData=null,this.render()})}_copyId(_event){let id=this.dataset.id;return console.log("Copying ID:",id),copyToClipboard(id)}_getGetterValueBound;_getGetterValue(event){event.stopImmediatePropagation(),event.preventDefault();let target=event.target;target&&(target.removeEventListener("click",this._getGetterValueBound),this._resolveGetter(target))}_resolveGetter(element){let el=element.dataset.path?element:element.closest("[data-path]");if(!el)return;let parentPath=el.dataset.path.split(".");parentPath.shift(),parentPath=parentPath.join(".");let ds=this.root.getAtPath(parentPath),value=ds.value;element.textContent=value,element.classList.add("resolved");let type=getTypeId(value),c=new DataStructure({key:ds.key,path:ds.path,value,type});element.classList.add(c.type)}getBasePath(path,oldMode,targetMode){return oldMode??=this._mode,oldMode==="rolldata"?path.replace(/^@/,""):targetMode==="rolldata"?path.replace(/^system\./,"@"):path}expandSelectedPath(){if(this._path.length==0)return;let path=this.getBasePath(this._path),p=this.paths.get(path);p&&(this.expandDataElTree(p.element),this._pathEl=p.element,this.highlightEl(this._pathEl,!0),this._pathEl.scrollIntoView({block:"center"}))}inputDebounceDelay=250;searchDelayTimer;selectDelayTimer;debounceSearch(search,event,active=!1){clearTimeout(this.searchDelayTimer),search.length===0&&(active=!1);let delay=Math.clamped(active?search.length>3?this.inputDebounceDelay:this.inputDebounceDelay*2:this.inputDebounceDelay/2,150,500);this.searchDelayTimer=setTimeout(_=>this.doSearch(search),delay)}debounceCustomPath(input,event,active=!1){this._path=input,this._pathEl&&(this._pathEl.classList.toggle("selected",!1),this._pathEl=null),clearTimeout(this.selectDelayTimer),input.length===0&&(active=!1);let delay=active?input.length>3?this.inputDebounceDelay:this.inputDebounceDelay*2:this.inputDebounceDelay/2;this.selectDelayTimer=setTimeout(_=>this.selectCustomPath(input),delay)}selectCustomPath(input){this._path=input,this.expandSelectedPath();let path=this.paths.get(input);path?(this.expandDataElTree(path.element),this.highlightEl(path.element),this._pathEl=path.element):this._pathEl=null}_lastSearch;lastEndSerch;doSearch(search,{forceRefresh=!1}={}){if(this._search=search,console.log("Searching:",this._search),forceRefresh!==!0&&this._lastSearch===search&&this.lastEndSerch===this._searchEnd)return;if(this._lastSearch=search,this.lastEndSerch=this._searchEnd,search.length==0){this.paths.forEach(p=>this.collapseAndClearEl(p.element,!1)),this.expandSelectedPath();return}this.paths.forEach(p=>this.collapseAndClearEl(p.element,!0));let term=search.toLowerCase().split("");function matchTerm(term2,subject,{harsh=!0}={}){let indexes=[],subjectParts=subject.toLowerCase().split(""),consecutives=0,longestChain=0,si=0,sm=term2[0],lastMatch=-2,lastChain=1,scoring=[],updateLongestChain=__name(()=>{lastChain>longestChain&&(longestChain=lastChain),lastChain=1},"updateLongestChain");for(let i=0;i<subjectParts.length;i++)if(subjectParts[i]===sm){indexes.push(i),lastMatch===i-1?(scoring.push(new Score(3,`Consecutive [${i}]: +3`)),consecutives++,lastChain++):(scoring.push(new Score(1,`Match [${i}]: +1`)),updateLongestChain()),lastMatch=i;let endBonus=Math.clamped(Math.round((subjectParts.length-i)/5),0,3);if(endBonus>0&&scoring.push(new Score(endBonus,`End bonus: +${endBonus}`)),sm=term2[++si],sm===void 0)break}updateLongestChain(),indexes.length>0?scoring.push(new Score(indexes.length*3,`Matched letters bonus: ${indexes.length*3}`)):scoring.push(new Score(-100,"No matches: -100"));let full=indexes.length==term2.length;full&&scoring.push(new Score(20,"Full match: +20"));let half=indexes.length<Math.floor(term2.length/2)-2;if(harsh){let cumulative=scoring.reduce((prev,cur)=>cur.value+prev),halfScore=-Math.floor(cumulative/2);half&&scoring.push(new Score(halfScore,`Partial match: ${halfScore}`)),longestChain<=1&&scoring.push(new Score(-20,"Short chains: -20"))}return new TermMatch({indexes,full,half,ratio:(consecutives+1)/term2.length,consecutives,longestChain,scoring})}__name(matchTerm,"matchTerm");let fullMatches0=0,fullMatches1=0,results=this.paths.reduce((results2,target)=>{let matchPath=matchTerm(term,target.path),matchKey=matchTerm(term,target.key);matchKey.full&&fullMatches0++,matchPath.full&&fullMatches1++;let match=matchPath.ratio>.5,ratio=matchPath.ratio;return this._keyFocus?(matchPath.score/=5,ratio=matchKey.ratio,match=matchKey.ratio>matchPath.ratio):(ratio+=matchKey.ratio*2,ratio/=3),results2.push(new SearchResult({path:target.path,match,target,keyFocus:this._keyFocus,score:matchPath.score/2+matchKey.score*2,keyFullMatch:matchKey.full,pathFullMatch:matchPath.full,pathIndexes:matchPath.indexes,keyIndexes:matchKey.indexes,ratio,scoring:{full:matchPath.scoring,key:matchKey.scoring}})),results2},[]);results.sort((a,b)=>a.full&&!b.full?-1:b.full&&!a.full?1:b.score-a.score);let Break={};try{results.forEach((r,index)=>{let el=r.target.element;el.dataset.searchScore=`${r.score}`,el.dataset.searchRatio=`${r.ratio}`;let q="decent";r.mismatch?q="mismatch":r.bad?q="bad":r.good&&(q="good"),el.dataset.matchQuality=q,fullMatches0>0?r.ratio>this._resultQuality&&this.expandDataElTree(el):r.bad||this.expandDataElTree(el)})}catch(err){if(err!==Break)throw err}this.expandSelectedPath()}async close(opts){return delete this.document.apps[this.appId],super.close(opts)}render(force=!1,options={}){return options.keepCache||(this._rollData=void 0,this._sourceData=void 0,this._derivedData=void 0,this._overrides=void 0,this._lastSearch=void 0),super.render(force,options)}},DataInspectorDialog=_DataInspectorDialog;__name(DataInspectorDialog,"DataInspectorDialog"),__publicField(DataInspectorDialog,"EDITABLE_MODES",["source","override","flags"]);var refreshActiveDialogs=__name(()=>Object.values(ui.windows).forEach(app=>app instanceof DataInspectorDialog?app.render():null),"refreshActiveDialogs");Hooks.once("init",__name(function(){game.settings.register(CFG.id,CFG.SETTINGS.mode,{name:"DataInspector.Settings.DefaultMode",hint:"DataInspector.Settings.DefaultModeHint",scope:"client",config:!0,type:String,default:"rolldata",choices:{rolldata:"DataInspector.Data.Roll",source:"DataInspector.Data.Source",derived:"DataInspector.Data.Derived"}}),game.settings.register(CFG.id,CFG.SETTINGS.results,{name:"DataInspector.Settings.ResultQuality",hint:"DataInspector.Settings.ResultQualityHint",scope:"client",config:!0,type:Number,default:.7,range:{min:0,max:1,step:.01}}),game.settings.register(CFG.id,CFG.SETTINGS.functions,{name:"DataInspector.Settings.IncludeFunctions",hint:"DataInspector.Settings.IncludeFunctionsHint",scope:"client",config:!0,type:Boolean,default:!1}),game.settings.register(CFG.id,CFG.SETTINGS.allowEditing,{name:"DataInspector.Settings.AllowEditing",hint:"DataInspector.Settings.AllowEditingHint",config:!0,scope:"world",type:Boolean,default:!1}),game.settings.register(CFG.id,CFG.SETTINGS.allowEditingUnsupported,{name:"DataInspector.Settings.AllowEditingUnsupported",hint:"DataInspector.Settings.AllowEditingUnsupportedHint",config:!0,scope:"world",type:Boolean,default:!1}),game.settings.register(CFG.id,CFG.SETTINGS.allowUsers,{name:"DataInspector.Settings.AllowUsers",hint:"DataInspector.Settings.AllowUsersHint",config:!0,scope:"world",type:Boolean,default:!0}),game.settings.register(CFG.id,CFG.SETTINGS.tooltip,{name:"DataInspector.Settings.Tooltip",hint:"DataInspector.Settings.TooltipHint",config:!0,scope:"client",type:Boolean,default:!0,onChange:()=>refreshActiveDialogs()})},"registerSettings"));var openInspector=__name(doc=>{let oldApp=Object.values(doc.apps).find(app=>app instanceof DataInspectorDialog);oldApp?oldApp.render(!0,{focus:!0}):new DataInspectorDialog(doc).render(!0)},"openInspector"),injectHeaderDataButton=__name((sheet,buttons)=>{!game.settings.get(CFG.id,CFG.SETTINGS.allowUsers)&&!game.user.isGM||buttons.unshift({class:"data-inspector",icon:"fas fa-atom",label:game.i18n.localize("DataInspector.DataButton"),onclick:_=>openInspector(sheet.document)})},"injectHeaderDataButton"),injectContextDataButton=__name(([directory],entries)=>{entries.push({name:"DataInspector.Context.OpenInspector",icon:'<i class="fas fa-atom"></i>',condition:()=>!(!game.settings.get(CFG.id,CFG.SETTINGS.allowUsers)&&!game.user.isGM),callback:async([entry])=>{let directoryId=directory.id,packId=directory.dataset.pack,documentId=entry.dataset.documentId,doc;if(packId)doc=await game.packs.get(packId)?.getDocument(documentId);else if(directoryId==="items")doc=game.items.get(documentId);else if(directoryId==="actors")doc=game.actors.get(documentId);else return void console.error("Unknown data source:",{directory,entry});doc?openInspector(doc):console.warning("Document not found:",{documentId,directoryId,packId})}})},"injectContextDataButton");Hooks.once("ready",async()=>{let C=CFG.COLORS;if(!game.settings.get(CFG.id,CFG.SETTINGS.allowUsers)&&!game.user.isGM)return void console.log(`%cDATA INSPECTOR%c \u{1F50D} | %c${mod.version}%c | User access blocked in settings.`,C.main,C.unset,C.id,C.unset);let templates=["object","inspector","value","object-data"];await loadTemplates(templates.map(t=>`modules/${CFG.id}/template/${t}.hbs`));let mod=game.modules.get(CFG.id);mod.api={inspect:openInspector},["pf1"].includes(game.system.id)&&await import(`./systems/${game.system.id}.mjs`).then(()=>console.log("%cDATA INSPECTOR%c \u{1F50D} | System extensions loaded %c\u2714",C.main,C.unset,"color:green")).catch(()=>console.log("%cDATA INSPECTOR%c \u{1F50D} | System extensions not found %c\u2718",C.main,C.unset,"color:red")),console.log(`%cDATA INSPECTOR%c \u{1F50D} | %c${mod.version}%c | READY`,C.main,C.unset,C.id,C.unset)});Hooks.on("getActorSheetHeaderButtons",injectHeaderDataButton);Hooks.on("getItemSheetHeaderButtons",injectHeaderDataButton);Hooks.on("getItemDirectoryEntryContext",injectContextDataButton);Hooks.on("getActorDirectoryEntryContext",injectContextDataButton);Hooks.on("getCompendiumEntryContext",injectContextDataButton);
//# sourceMappingURL=data-inspector.mjs.map
